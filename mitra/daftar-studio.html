<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daftarkan Studio - Mitra</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/style.css"> 
    
  </head>

  <body>
    <div class="daftarkan-mitra">
      <div class="mitra-header">
        <h1 class="mitra-header-title">Daftarkan Studio Anda</h1>
        <p class="mitra-header-desc">
          Lengkapi data untuk mulai menyewakan studio
        </p>
      </div>

      <form
        id="form-daftar-mitra"
        class="dm-form-wrapper"
        onsubmit="handleFinalSubmit(event)"
      >
        <div class="dm-stepper">
          <div class="dm-step-item">
            <div class="dm-step-circle active">1</div>
            <div class="dm-step-line"></div>
          </div>
          <div class="dm-step-item">
            <div class="dm-step-circle">2</div>
            <div class="dm-step-line"></div>
          </div>
          <div class="dm-step-item">
            <div class="dm-step-circle">3</div>
            <div class="dm-step-line"></div>
          </div>
          <div class="dm-step-item"><div class="dm-step-circle">4</div></div>
        </div>

        <section class="dm-step active">
          <h2 class="dm-section-title">Informasi Dasar Studio</h2>

          <div class="dm-field-group">
            <label class="dm-label">Nama Studio *</label>
            <input
              class="dm-input"
              name="studio_name"
              placeholder="Contoh: Studio PhotoBox Bekasi"
              required
            />
          </div>

          <div class="dm-field-group">
            <label class="dm-label">Tipe Studio *</label>
            <div class="dm-radio-group">
              <input
                type="radio"
                id="t1"
                name="studio_type"
                value="photobox"
                checked
              /><label for="t1" class="dm-radio-btn">PhotoBox</label>
              <input
                type="radio"
                id="t2"
                name="studio_type"
                value="photostudio"
              /><label for="t2" class="dm-radio-btn">PhotoStudio</label>
            </div>
          </div>

          <div class="dm-field-group">
            <label class="dm-label">Deskripsi Studio *</label>
            <textarea
              class="dm-textarea"
              name="description"
              placeholder="Jelaskan fasilitas dan keunggulan studio..."
              required
            ></textarea>
          </div>

          <div class="dm-field-group">
            <label for="dm_addr" class="dm-label">Alamat Lengkap *</label>
            <textarea
              id="dm_addr"
              name="address"
              class="dm-textarea"
              style="min-height: 100px"
              placeholder="Jl. Contoh No. 123, Bekasi Timur..."
              required
            ></textarea>
          </div>

          <div class="dm-field-group">
            <label for="dm_city" class="dm-label">Kota *</label>
            <select id="dm_city" name="city" class="dm-select" required>
              <option value="" disabled selected>Pilih Kota</option>
              <option value="bekasi">Bekasi</option>
              <option value="jakarta">Jakarta</option>
              <option value="bandung">Bandung</option>
              <option value="tangerang">Tangerang</option>
              <option value="depok">Depok</option>
              <option value="bogor">Bogor</option>
            </select>
          </div>

          <div class="dm-grid-row">
            <div class="dm-field-group">
              <label for="dm_lat" class="dm-label">Latitude</label>
              <input
                type="number"
                step="any"
                id="dm_lat"
                name="latitude"
                class="dm-input"
                placeholder="-6.2349"
              />
            </div>
            <div class="dm-field-group">
              <label for="dm_long" class="dm-label">Longitude</label>
              <input
                type="number"
                step="any"
                id="dm_long"
                name="longitude"
                class="dm-input"
                placeholder="106.9896"
              />
            </div>
          </div>
          <div class="dm-footer">
            <span></span>
            <button
              type="button"
              class="dm-btn-next"
              onclick="validateAndNext(this)"
            >
              Lanjut
            </button>
          </div>
        </section>

        <section class="dm-step">
          <h2 class="dm-section-title">Fasilitas & Media</h2>

          <div class="dm-field-group">
            <label class="dm-label">Fasilitas Studio (Minimal 1) *</label>
            <div id="facility-container">
              <div class="dm-dynamic-row">
                <input
                  class="dm-input"
                  name="facilities[]"
                  placeholder="Contoh: Free WiFi"
                  required
                />
                <button
                  type="button"
                  class="dm-action-btn"
                  onclick="addFacility()"
                >
                  +
                </button>
              </div>
            </div>
          </div>

          <div class="dm-field-group">
            <label class="dm-label">Upload Foto Studio (Max 10 Foto) *</label>

            <input
              type="file"
              id="image-input-trigger"
              class="dm-input"
              accept="image/*"
              multiple
              onchange="handleNewImages(this)"
            />
            <small
              style="
                color: #6b7280;
                font-size: 12px;
                margin-top: 4px;
                display: block;
              "
              >Klik untuk memilih foto. Anda bisa memilih beberapa file
              sekaligus.</small
            >

            <div id="image-counter" class="image-counter-text">
              0 / 10 Foto Terpilih
            </div>
            <div id="image-error" class="image-error-msg"></div>

            <div id="image-preview-container"></div>
          </div>

          <div class="dm-field-group">
            <label class="dm-label">Range Harga (Display Only) *</label>
            <input
              class="dm-input"
              name="price_range"
              placeholder="Contoh: Rp 50.000 – Rp 250.000"
              required
            />
          </div>

          <div class="dm-footer">
            <button type="button" class="dm-btn-back" onclick="prevStep()">
              Kembali
            </button>
            <button
              type="button"
              class="dm-btn-next"
              onclick="validateAndNext(this)"
            >
              Lanjut
            </button>
          </div>
        </section>

        <section class="dm-step">
          <h2 class="dm-section-title">Jam Operasional</h2>
          <p style="margin-bottom: 16px; font-size: 14px; color: #666">
            Format 24 Jam (Contoh: 09:00 - 21:00)
          </p>
          <div class="dm-schedule-item">
            <strong>Senin *</strong>
            <div class="dm-schedule-inputs">
              <input
                type="time"
                class="dm-input dm-time schedule-open"
                name="schedule[senin][open]"
                required
              />
              <span>s/d</span>
              <input
                type="time"
                class="dm-input dm-time schedule-close"
                name="schedule[senin][close]"
                required
              />
            </div>
          </div>
          <div style="text-align: right; margin-bottom: 20px">
            <button type="button" class="dm-btn-copy" onclick="copyMonday()">
              ↓ Terapkan jam Senin ke semua hari
            </button>
          </div>
          <div id="other-days">
            <div class="dm-schedule-item">
              <strong>Selasa</strong>
              <div class="dm-schedule-inputs">
                <input
                  type="time"
                  class="dm-input dm-time schedule-open"
                  name="schedule[selasa][open]"
                /><span>s/d</span
                ><input
                  type="time"
                  class="dm-input dm-time schedule-close"
                  name="schedule[selasa][close]"
                />
              </div>
            </div>
            <div class="dm-schedule-item">
              <strong>Rabu</strong>
              <div class="dm-schedule-inputs">
                <input
                  type="time"
                  class="dm-input dm-time schedule-open"
                  name="schedule[rabu][open]"
                /><span>s/d</span
                ><input
                  type="time"
                  class="dm-input dm-time schedule-close"
                  name="schedule[rabu][close]"
                />
              </div>
            </div>
            <div class="dm-schedule-item">
              <strong>Kamis</strong>
              <div class="dm-schedule-inputs">
                <input
                  type="time"
                  class="dm-input dm-time schedule-open"
                  name="schedule[kamis][open]"
                /><span>s/d</span
                ><input
                  type="time"
                  class="dm-input dm-time schedule-close"
                  name="schedule[kamis][close]"
                />
              </div>
            </div>
            <div class="dm-schedule-item">
              <strong>Jumat</strong>
              <div class="dm-schedule-inputs">
                <input
                  type="time"
                  class="dm-input dm-time schedule-open"
                  name="schedule[jumat][open]"
                /><span>s/d</span
                ><input
                  type="time"
                  class="dm-input dm-time schedule-close"
                  name="schedule[jumat][close]"
                />
              </div>
            </div>
            <div class="dm-schedule-item">
              <strong>Sabtu</strong>
              <div class="dm-schedule-inputs">
                <input
                  type="time"
                  class="dm-input dm-time schedule-open"
                  name="schedule[sabtu][open]"
                /><span>s/d</span
                ><input
                  type="time"
                  class="dm-input dm-time schedule-close"
                  name="schedule[sabtu][close]"
                />
              </div>
            </div>
            <div class="dm-schedule-item">
              <strong>Minggu</strong>
              <div class="dm-schedule-inputs">
                <input
                  type="time"
                  class="dm-input dm-time schedule-open"
                  name="schedule[minggu][open]"
                /><span>s/d</span
                ><input
                  type="time"
                  class="dm-input dm-time schedule-close"
                  name="schedule[minggu][close]"
                />
              </div>
            </div>
          </div>
          <div class="dm-footer">
            <button type="button" class="dm-btn-back" onclick="prevStep()">
              Kembali
            </button>
            <button
              type="button"
              class="dm-btn-next"
              onclick="validateAndNext(this)"
            >
              Lanjut
            </button>
          </div>
        </section>

        <section class="dm-step">
          <h2 class="dm-section-title">Paket Layanan</h2>
          <div id="packages-container">
            <div class="dm-package-card">
              <div class="dm-field-group">
                <label class="dm-label">Nama Paket *</label>
                <input
                  class="dm-input"
                  name="packages[0][name]"
                  placeholder="Contoh: Paket Foto Keluarga"
                  required
                />
              </div>
              <div class="dm-field-group">
                <label class="dm-label">Harga Paket (Rp) *</label>
                <input
                  type="number"
                  class="dm-input"
                  name="packages[0][price]"
                  placeholder="150000"
                  required
                />
              </div>
              <div class="dm-field-group">
                <label class="dm-label">Deskripsi Paket</label>
                <textarea
                  class="dm-textarea"
                  name="packages[0][description]"
                  style="min-height: 60px"
                  placeholder="Durasi 15 menit, 2 orang, dst..."
                ></textarea>
              </div>
            </div>
          </div>
          <button type="button" class="dm-btn-dashed" onclick="addPackage()">
            + Tambah Paket Lain
          </button>
          <div class="dm-footer">
            <button type="button" class="dm-btn-back" onclick="prevStep()">
              Kembali
            </button>
            <button type="submit" class="dm-btn-next">
              Selesai & Daftarkan
            </button>
          </div>
        </section>
      </form>
    </div>
    <script>
      let currentStep = 0;
      const steps = document.querySelectorAll(".dm-step");
      const circles = document.querySelectorAll(".dm-step-circle");
      const lines = document.querySelectorAll(".dm-step-line");
      function renderStep() {
        steps.forEach((s, i) =>
          s.classList.toggle("active", i === currentStep)
        );
        circles.forEach((c, i) => {
          c.classList.toggle("active", i <= currentStep);
        });
        lines.forEach((l, i) => {
          if (i < lines.length) {
            l.classList.toggle("active", i < currentStep);
          }
        });
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
      function nextStep() {
        if (currentStep < steps.length - 1) {
          currentStep++;
          renderStep();
        }
      }
      function prevStep() {
        if (currentStep > 0) {
          currentStep--;
          renderStep();
        }
      }
      document.addEventListener("DOMContentLoaded", renderStep);

      let selectedStudioImages = [];
      const MAX_IMAGES = 10;

      function handleNewImages(input) {
        const errorDiv = document.getElementById("image-error");
        errorDiv.style.display = "none";
        const newFiles = Array.from(input.files);

        if (selectedStudioImages.length + newFiles.length > MAX_IMAGES) {
          errorDiv.innerText = `Gagal menambahkan. Maksimal total ${MAX_IMAGES} foto.`;
          errorDiv.style.display = "block";
          input.value = "";
          return;
        }

        newFiles.forEach((file) => {
          selectedStudioImages.push(file);
        });
        input.value = "";
        renderImagePreviews();
      }

      function renderImagePreviews() {
        const container = document.getElementById("image-preview-container");
        const counter = document.getElementById("image-counter");
        container.innerHTML = "";
        counter.innerText = `${selectedStudioImages.length} / ${MAX_IMAGES} Foto Terpilih`;

        selectedStudioImages.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const wrapper = document.createElement("div");
            wrapper.className = "img-preview-wrapper";
            wrapper.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index}">
                <button type="button" class="img-remove-btn" onclick="removeImage(${index})">×</button>
            `;
            container.appendChild(wrapper);
          };
          reader.readAsDataURL(file);
        });
      }

      function removeImage(index) {
        selectedStudioImages.splice(index, 1);
        renderImagePreviews();
      }

      function validateAndNext(btn) {
        const stepEl = btn.closest(".dm-step");
        const fields = stepEl.querySelectorAll(
          "input:not([type=file]), textarea, select"
        );
        let isValid = true;

        for (const f of fields) {
          if (!f.checkValidity()) {
            f.reportValidity();
            isValid = false;
            break;
          }
        }

        if (currentStep === 1 && isValid) {
          const errorDiv = document.getElementById("image-error");
          if (selectedStudioImages.length === 0) {
            errorDiv.innerText = "Wajib mengupload minimal 1 foto studio.";
            errorDiv.style.display = "block";
            document
              .getElementById("image-input-trigger")
              .scrollIntoView({ behavior: "smooth", block: "center" });
            isValid = false;
          } else {
            errorDiv.style.display = "none";
          }
        }

        if (isValid) nextStep();
      }

      const STORAGE_KEY = "mitra_form_final";
      function saveForm() {
        const data = {};
        const form = document.getElementById("form-daftar-mitra");
        const inputs = form.querySelectorAll(
          'input:not([type="file"]), textarea, select'
        );

        inputs.forEach((input) => {
          if (input.name) {
            if (input.type === "radio") {
              if (input.checked) data[input.name] = input.value;
            } else {
              if (input.name.includes("[]")) {
                if (!data[input.name]) data[input.name] = [];
                data[input.name].push(input.value);
              } else {
                data[input.name] = input.value;
              }
            }
          }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      function restoreForm() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          const form = document.getElementById("form-daftar-mitra");
          Object.keys(data).forEach((k) => {
            const el = form.querySelector(`[name="${k}"]`);
            if (el && el.type !== "radio" && !k.includes("[]")) {
              el.value = data[k];
            }
            if (el && el.type === "radio") {
              const radio = form.querySelector(
                `[name="${k}"][value="${data[k]}"]`
              );
              if (radio) radio.checked = true;
            }
          });
        } catch (e) {
          console.error("Error restoring form", e);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        restoreForm();
        document
          .getElementById("form-daftar-mitra")
          .addEventListener("input", saveForm);
        document
          .getElementById("form-daftar-mitra")
          .addEventListener("change", saveForm);
      });

      function addFacility() {
        const container = document.getElementById("facility-container");
        const div = document.createElement("div");
        div.className = "dm-dynamic-row";
        div.innerHTML =
          '<input class="dm-input" name="facilities[]" placeholder="Fasilitas lainnya..." required><button type="button" class="dm-action-btn remove" onclick="this.parentElement.remove(); saveForm()">×</button>';
        container.appendChild(div);
      }

      function copyMonday() {
        const monOpen = document.querySelector(
          'input[name="schedule[senin][open]"]'
        ).value;
        const monClose = document.querySelector(
          'input[name="schedule[senin][close]"]'
        ).value;
        if (!monOpen || !monClose) {
          alert("Harap isi jam buka dan tutup hari Senin terlebih dahulu.");
          return;
        }
        const otherDays = document.querySelectorAll(
          "#other-days .dm-schedule-item"
        );
        otherDays.forEach((dayRow) => {
          dayRow.querySelector(".schedule-open").value = monOpen;
          dayRow.querySelector(".schedule-close").value = monClose;
        });
        saveForm();
      }

      function addPackage() {
        const container = document.getElementById("packages-container");
        const index = container.children.length;
        const div = document.createElement("div");
        div.className = "dm-package-card";
        div.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:10px"><strong>Paket #${
          index + 1
        }</strong><button type="button" style="color:red; background:none; border:none; cursor:pointer" onclick="this.closest('.dm-package-card').remove()">Hapus</button></div><div class="dm-field-group"><label class="dm-label">Nama Paket *</label><input class="dm-input" name="packages[${index}][name]" required></div><div class="dm-field-group"><label class="dm-label">Harga Paket (Rp) *</label><input type="number" class="dm-input" name="packages[${index}][price]" required></div><div class="dm-field-group"><label class="dm-label">Deskripsi Paket</label><textarea class="dm-textarea" style="min-height:60px" name="packages[${index}][description]"></textarea></div>`;
        container.appendChild(div);
      }

      function handleFinalSubmit(e) {
        e.preventDefault();

        const stepEl = steps[steps.length - 1];
        const fields = stepEl.querySelectorAll("input, textarea, select");
        for (const f of fields) {
          if (!f.checkValidity()) {
            f.reportValidity();
            return;
          }
        }

        const form = document.getElementById("form-daftar-mitra");
        const formData = new FormData(form);

        formData.delete("studio_images");
        selectedStudioImages.forEach((file) => {
          formData.append("studio_images[]", file);
        });

        const btn = document.querySelector('.dm-btn-next[type="submit"]');
        btn.innerText = "Mengirim...";
        btn.disabled = true;

        setTimeout(() => {
          alert(
            "Pendaftaran Berhasil! Data studio dan " +
              selectedStudioImages.length +
              " foto telah dikirim."
          );
          localStorage.removeItem(STORAGE_KEY);
          window.location.reload();
        }, 1500);
      }
    </script>
  </body>
</html>
